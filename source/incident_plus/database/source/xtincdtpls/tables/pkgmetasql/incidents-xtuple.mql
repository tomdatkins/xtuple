-- Group: incidents
-- Name:  xtuple
-- Notes: Local extended list of fields for xtincident
 
SELECT DISTINCT ON (incdtpriority_order, incdt_number) incdt_id,
incdt_number, DATE(incdt_timestamp) AS incdt_timestamp,
crmacct_name, incdt_owner_username,  
incdtcat_name, incdtseverity_name,  
incdtpriority_name, crmacct_name, 
CASE WHEN(incdt_status='N') THEN <? value("new") ?>
WHEN(incdt_status='F') THEN <? value("feedback") ?>
WHEN(incdt_status='C') THEN <? value("confirmed") ?>
WHEN(incdt_status='A') THEN <? value("assigned") ?>
WHEN(incdt_status='R') THEN <? value("resolved") ?>
WHEN(incdt_status='L') THEN <? value("closed") ?>
ELSE incdt_status
END,
incdt_assigned_username, incdt_owner_username,
incdt_summary, cntct_name, incdt_updated::date AS incdt_updated,
prj_number, incdt_public,
foundver.prjver_version AS found_version,
fixedver.prjver_version AS fixed_version,
foundrev.rev_number AS found_revision,
fixedrev.rev_number AS fixed_revision,

status_color AS qtbackgroundrole 
<? foreach("char_id_text_list") ?>
  , charass_alias<? literal("char_id_text_list") ?>.charass_value AS char<? literal("char_id_text_list") ?>
<? endforeach ?>
<? foreach("char_id_list_list") ?>
  , charass_alias<? literal("char_id_list_list") ?>.charass_value AS char<? literal("char_id_list_list") ?>
<? endforeach ?>
<? foreach("char_id_date_list") ?>
  , charass_alias<? literal("char_id_date_list") ?>.charass_value::date AS char<? literal("char_id_date_list") ?>
<? endforeach ?>
FROM crmacct, status, incdt
  JOIN cntct ON (incdt_cntct_id=cntct_id)
  LEFT OUTER JOIN incdtcat ON (incdtcat_id=incdt_incdtcat_id) 
  LEFT OUTER JOIN incdtseverity ON (incdtseverity_id=incdt_incdtseverity_id) 
  LEFT OUTER JOIN incdtpriority ON (incdtpriority_id=incdt_incdtpriority_id) 
  LEFT OUTER JOIN prj ON (incdt_prj_id=prj_id)
  LEFT OUTER JOIN xtincdtpls.incdtver ON (incdt_id=incdtver_incdt_id)
  LEFT OUTER JOIN xtincdtpls.prjver foundver ON (incdtver_found_prjver_id=foundver.prjver_id)
  LEFT OUTER JOIN xtincdtpls.prjver fixedver ON (incdtver_fixed_prjver_id=fixedver.prjver_id)
  -- ADDED for new xtincidtpls move prj to item
  LEFT OUTER JOIN xtincdtpls.incdtbomver ON (incdt_id = incdtbomver_incdt_id)
  LEFT OUTER JOIN rev foundrev ON (foundrev.rev_id = incdtbomver_found_rev_id)
  LEFT OUTER JOIN rev fixedrev ON (fixedrev.rev_id = incdtbomver_fixed_rev_id)

<? foreach("char_id_text_list") ?>
  LEFT OUTER JOIN charass charass_alias<? literal("char_id_text_list") ?> ON ((charass_alias<? literal("char_id_text_list") ?>.charass_target_type='INCDT') 
                                                                    AND  (charass_alias<? literal("char_id_text_list") ?>.charass_target_id=incdt_id)
                                                                    AND  (charass_alias<? literal("char_id_text_list") ?>.charass_char_id=<? value("char_id_text_list") ?>))
  LEFT OUTER JOIN char char_alias<? literal("char_id_text_list") ?> ON (charass_alias<? literal("char_id_text_list") ?>.charass_char_id=char_alias<? literal("char_id_text_list") ?>.char_id)
<? endforeach ?>
<? foreach("char_id_list_list") ?>
  LEFT OUTER JOIN charass charass_alias<? literal("char_id_list_list") ?> ON ((charass_alias<? literal("char_id_list_list") ?>.charass_target_type='INCDT') 
                                                                    AND  (charass_alias<? literal("char_id_list_list") ?>.charass_target_id=incdt_id)
                                                                    AND  (charass_alias<? literal("char_id_list_list") ?>.charass_char_id=<? value("char_id_list_list") ?>))
  LEFT OUTER JOIN char char_alias<? literal("char_id_list_list") ?> ON (charass_alias<? literal("char_id_list_list") ?>.charass_char_id=char_alias<? literal("char_id_list_list") ?>.char_id)
<? endforeach ?>
<? foreach("char_id_date_list") ?>
  LEFT OUTER JOIN charass charass_alias<? literal("char_id_date_list") ?> ON ((charass_alias<? literal("char_id_date_list") ?>.charass_target_type='INCDT') 
                                                                    AND  (charass_alias<? literal("char_id_date_list") ?>.charass_target_id=incdt_id)
                                                                    AND  (charass_alias<? literal("char_id_date_list") ?>.charass_char_id=<? value("char_id_date_list") ?>))
  LEFT OUTER JOIN char char_alias<? literal("char_id_date_list") ?> ON (charass_alias<? literal("char_id_date_list") ?>.charass_char_id=char_alias<? literal("char_id_date_list") ?>.char_id)
<? endforeach ?>
WHERE ((incdt_crmacct_id=crmacct_id)
AND (status_type='INCDT')
AND (incdt_status=status_code)
<? if exists("username") ?>
AND (<? value("username") ?> IN (incdt_assigned_username, incdt_owner_username))
<? endif ?>
<? if exists("statuslist") ?>
AND (status_seq IN (-1
  <? foreach("statuslist") ?> , <? value("statuslist") ?> <? endforeach ?>
  ))
<? elseif exists("status_equal") ?> 
AND (status_seq = <? value("status_equal") ?>) 
<? endif ?>
<? if exists("status_above") ?> 
AND (status_seq < <? value("status_above") ?>) 
<? endif ?>
<? if exists("cntct_id") ?> 
AND (incdt_cntct_id = <? value("cntct_id") ?>) 
<? endif ?>
<? if exists("owner_username") ?> 
AND (incdt_owner_username=<? value("owner_username") ?>) 
<? elseif exists("owner_usr_pattern" ?>
AND (incdt_owner_username ~ <? value("owner_usr_pattern") ?>) 
<? endif ?>
<? if exists("assigned_username") ?> 
AND (incdt_assigned_username=<? value("assigned_username") ?>) 
<? elseif exists("assigned_usr_pattern" ?>
AND (incdt_assigned_username ~ <? value("assigned_usr_pattern") ?>) 
<? endif ?>
<? if exists("categorylist") ?>
AND (incdt_incdtcat_id IN (-1
  <? foreach("categorylist") ?> , <? value("categorylist") ?> <? endforeach ?>
  ))
<? elseif exists("category_id") ?> 
AND (incdt_incdtcat_id=<? value("category_id") ?>) 
<? endif ?> 
<? if exists("incdtpriority_id_list") ?>
AND (incdt_incdtpriority_id IN (-1
  <? foreach("incdtpriority_id_list") ?> , <? value("incdtpriority_id_list") ?> <? endforeach ?>
  ))
<? endif ?>
<? if exists("severity_id") ?> 
AND (incdt_incdtseverity_id=<? value("severity_id") ?>) 
<? endif ?>
<? if exists("crmAccountId") ?> 
AND (incdt_crmacct_id=<? value("crmAccountId") ?>) 
<? endif ?> 
<? if exists("prj_id") ?> 
AND (incdt_prj_id=<? value("prj_id") ?>) 
<? endif ?> 
<? if exists("prjisnull") ?>
AND incdt_prj_id IS NULL
<? endif ?>
<? if exists("prjList") ?>
AND (incdt_prj_id IN (-1
  <? foreach("prjList") ?> , <? value("prjList") ?> <? endforeach ?>
  ))
<? endif ?>
<? if exists("public") ?> 
AND (incdt_public=<? value("public") ?>) 
<? endif ?> 
<? if exists("foundverList") ?>
AND (foundver.prjver_version IN (
  <? foreach("foundverList") ?>
    <? if not isFirst("foundverList") ?>
    ,
    <? endif ?>
    <? value("foundverList") ?> 
  <? endforeach ?>
  ))
<? endif ?>
<? if exists("fixedverList") ?>
AND (fixedver.prjver_version IN (
  <? foreach("fixedverList") ?>
    <? if not isFirst("fixedverList") ?>
    ,
    <? endif ?>
    <? value("fixedverList") ?> 
  <? endforeach ?>
  ))
<? endif ?>
)
 
<? if exists("search_pattern") ?> 
AND ((incdt_number::text ~* <? value("search_pattern") ?>)
OR (incdt_summary ~* <? value("search_pattern") ?>)
OR (incdt_descrip ~* <? value("search_pattern") ?>)
OR (incdt_id IN (SELECT comment_source_id
FROM comment
WHERE((comment_source='INCDT')
AND (comment_text ~* <? value("search_pattern") ?>)))))
<? endif ?>
AND (incdt_timestamp BETWEEN <? value("startDate") ?> AND DATE <? value("endDate") ?>+1) 
<? literal("charClause") ?>
ORDER BY incdtpriority_order, incdt_number;
